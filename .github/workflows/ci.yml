name: CI

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  shell-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      - name: Bash syntax
        run: |
          bash -n sing-box-deve.sh lib/*.sh providers/*.sh scripts/*.sh
      - name: Enforce max 400 lines per shell file
        run: |
          failed=0
          for f in sing-box-deve.sh lib/*.sh providers/*.sh scripts/*.sh; do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 400 ]; then
              echo "File too long ($lines > 400): $f"
              failed=1
            fi
          done
          [ "$failed" -eq 0 ]
      - name: Shellcheck
        run: |
          shellcheck sing-box-deve.sh lib/*.sh providers/*.sh scripts/*.sh
      - name: JSON examples validation
        run: |
          node -e "const fs=require('fs'); JSON.parse(fs.readFileSync('examples/serv00-accounts.json','utf8')); JSON.parse(fs.readFileSync('examples/sap-accounts.json','utf8'));"
      - name: Verify checksums manifest
        run: |
          ./scripts/update-checksums.sh
          git diff --exit-code checksums.txt
